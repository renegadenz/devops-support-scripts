import os
import pandas as pd
from ipwhois import IPWhois
import time

# Get CSV file path from environment variable
csv_file = os.getenv("FLOW_LOGS_CSV")

if not csv_file:
    raise EnvironmentError("âŒ ERROR: Environment variable 'FLOW_LOGS_CSV' is not set.")
if not os.path.exists(csv_file):
    raise FileNotFoundError(f"âŒ ERROR: CSV file not found at: {csv_file}")

print(f"ğŸ“‚ Loading CSV file: {csv_file}...")

# Load CSV with tab or space delimiter detection
df = pd.read_csv(csv_file, sep="\t", engine="python")

# Ensure 'message' column exists
if "message" not in df.columns:
    raise ValueError("âŒ ERROR: The CSV file does not contain a 'message' column.")

print(f"âœ… CSV loaded successfully. Found {len(df)} rows.")

# Extract source IPs (4th item in space-separated 'message' field)
df["source_ip"] = df["message"].apply(lambda x: x.split()[3] if isinstance(x, str) and len(x.split()) > 3 else None)

# Remove duplicates and drop empty values
source_ips = df["source_ip"].dropna().unique()
print(f"ğŸ” Extracted {len(source_ips)} unique source IPs.")

# WHOIS lookup function
def get_org_from_ip(ip):
    try:
        print(f"ğŸŒ Performing WHOIS lookup for {ip}...")
        obj = IPWhois(ip)
        result = obj.lookup_rdap()
        organization = result.get("network", {}).get("name", "Unknown")
        print(f"âœ… WHOIS lookup complete: {ip} â†’ {organization}")
        return organization
    except Exception as e:
        print(f"âš ï¸ WHOIS lookup failed for {ip}: {e}")
        return f"Error: {e}"

# Perform WHOIS lookups with progress
results = []
for idx, ip in enumerate(source_ips, start=1):
    print(f"ğŸ” Processing {idx}/{len(source_ips)}: {ip}")
    results.append({"IP Address": ip, "Organization": get_org_from_ip(ip)})
    time.sleep(1)  # Prevent rate limiting

# Convert to DataFrame
df_results = pd.DataFrame(results)

# Define output CSV file name
output_csv = os.path.join(os.path.dirname(csv_file), "whois_lookup_results.csv")

# Save results to CSV
df_results.to_csv(output_csv, index=False)

print("\nâœ… WHOIS lookup completed!")
print(f"ğŸ“„ Results saved to: {output_csv}")
print(f"ğŸ“Š Total IPs processed: {len(source_ips)}")
